{% set data = salt['mc_utils.json_load'](data) %}
{% set cfg = salt['mc_project.get_configuration'](data.project) %}
{% set ddata = cfg.data %}
{% set plone = ddata.buildout.settings.v.plonesite %}

{% if ddata.get('force_ssl', False) %}
if ($forwarded_ssl_scheme != "https"){
  rewrite ^(.*)$ https://{{ddata.domain}}$1 permanent;
}
{% endif %}

{% macro auth() %}
{% if ddata.get('ldap_url', '') %}
auth_ldap "Restricted(ldap)";
auth_ldap_servers {{cfg.name}}auth;
{% elif ddata.get('http_users', {}) %}
auth_basic            "Restricted";
auth_basic_user_file  {{ddata.htaccess}};
{% endif %}
{% endmacro %}

{% macro setacac() %}
       add_header 'Access-Control-Allow-Origin' '*';
       add_header 'Access-Control-Allow-Credentials' 'true';
       add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, OPTIONS';
       add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
{% endmacro %}
{% macro setaca() %}
    if ($request_method = 'OPTIONS') {
       {{ setacac() }}
       add_header 'Access-Control-Max-Age' 1728000;
       add_header 'Content-Type' 'text/plain charset=UTF-8';
       add_header 'Content-Length' 0;
       return 204;
    }
    if ($request_method = 'POST') {
       {{ setacac() }}
    }
    if ($request_method = 'GET') {
       {{ setacac() }}
    }
    if ($request_method = 'PUT') {
       {{ setacac() }}
    }
    if ($request_method = 'PATCH') {
       {{ setacac() }}
    }
{% endmacro %}

location /zmiroot/ {
 {{auth()}}
 {{setaca()}}
 proxy_pass http://{{ddata.front_host}}:{{ddata.front_port}}/VirtualHostBase/{{ddata.reverse_proxy_scheme}}/$host:$forwarded_server_port/VirtualHostRoot/_vh_zmiroot/;

}

location / {
 {{auth()}}
 {{setaca()}}
 rewrite ^(/zmiroot/.*)$ /VirtualHostBase/{{ddata.reverse_proxy_scheme}}/$host:$forwarded_server_port/_vh_zmiroot/$1 break;
 rewrite ^(.*)$          /VirtualHostBase/{{ddata.reverse_proxy_scheme}}/$host:$forwarded_server_port/{{plone}}/VirtualHostRoot/$1 break;
 proxy_pass http://{{ddata.front_host}}:{{ddata.front_port}};
}
