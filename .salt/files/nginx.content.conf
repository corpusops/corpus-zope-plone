{% set data = salt['mc_utils.json_load'](data) %}
{% set cfg = salt['mc_project.get_configuration'](data.project) %}
{% set ddata = cfg.data %}
{% set plone = ddata.buildout.settings.v.plonesite %}

{% if ddata.get('force_ssl', False) %}
if ($forwarded_ssl_scheme != "https"){
  rewrite ^(.*)$ https://{{ddata.domain}}$1 permanent;
}
{% endif %}

{% macro auth() %}
{% if ddata.get('ldap_url', '') %}
auth_ldap "Restricted(ldap)";
auth_ldap_servers {{cfg.name}}auth;
{% elif ddata.get('http_users', {}) %}
auth_basic            "Restricted";
auth_basic_user_file  {{ddata.htaccess}};
{% endif %}
{% endmacro %}

location /zmiroot/ {
 {{auth()}}
 proxy_pass http://{{ddata.front_host}}:{{ddata.front_port}}/VirtualHostBase/{{ddata.reverse_proxy_scheme}}/$host:$forwarded_server_port/VirtualHostRoot/_vh_zmiroot/;
}

location / {
 {{auth()}}
    set $maint "n";
    if ( -f {{ddata.doc_root}}/maintainance/index.html ){
        set $maint "m";
    }
    if ( $uri ~ ^/maintainance ) {
        set $maint "o$maint";
    }
    if ( $maint = "m" ) {
        rewrite ^(.*)$ /maintainance/index.html permanent;
    }
    if ( $maint = "n" ){
            rewrite ^(/zmiroot/.*)$ /VirtualHostBase/{{ddata.reverse_proxy_scheme}}/$host:$forwarded_server_port/_vh_zmiroot/$1 break;
            rewrite ^(.*)$          /VirtualHostBase/{{ddata.reverse_proxy_scheme}}/$host:$forwarded_server_port/{{plone}}/VirtualHostRoot/$1 break;
            proxy_pass http://{{ddata.front_host}}:{{ddata.front_port}};
    }
}
